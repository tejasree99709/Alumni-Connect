<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Users | Alumni Connect</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
  body { font-family: 'Roboto', sans-serif; background-color: #b1e5f2; margin:0; padding:0; }
  .topbar { background-color: #1c2434; color:#fff; padding:15px 30px; display:flex; justify-content:space-between; align-items:center; }
  .topbar h1 { font-size:1.5rem; margin:0 auto; }
  .content-container { max-width:1100px; margin:40px auto; background:#2f3d5a; padding:30px; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.1); color:#fff; }
  .table thead { background-color:#1c2434; color:#fff; }
  .table tbody tr { background-color:#3e4b6b; color:#fff; }
  .table tbody tr:hover { background-color:#505e82; }
  .btn-custom { background-color:#b1e5f2; color:#000; border-radius:5px; }
  .btn-custom:hover { background-color:#96d3e6; }
  .filter-container { background:#3e4b6b; padding:15px; border-radius:6px; margin-bottom:20px; }
  .filter-container label { color:#fff; font-weight:500; }
  #loading { text-align:center; margin:15px 0; color:#fff; display:none; }
</style>
</head>
<body>

<div class="topbar">
  <h1><i class="fas fa-users"></i> View Users</h1>
  <a href="Admindashboard.html" class="btn btn-danger"><i class="fas fa-arrow-left"></i> Back</a>
</div>

<div class="content-container">
  <!-- Heading + Export button -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0"><i class="fas fa-user-graduate"></i> Alumni & Students List</h3>
    <button class="btn btn-success" onclick="exportTableToCSV('users_export.csv')">
      <i class="fas fa-file-export"></i> Export CSV
    </button>
  </div>

  <!-- Filters -->
  <div class="filter-container mb-4">
    <form id="filterForm" class="row g-3">
      <div class="col-md-3">
        <label class="form-label"><i class="fas fa-user"></i> Name</label>
        <input type="text" class="form-control" id="filterName" placeholder="Enter name">
      </div>
      <div class="col-md-3">
        <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
        <input type="email" class="form-control" id="filterEmail" placeholder="Enter email">
      </div>
      <div class="col-md-3">
        <label class="form-label"><i class="fas fa-user-tag"></i> Role</label>
        <select class="form-select" id="filterRole">
          <option value="">All</option>
          <option value="Alumni">Alumni</option>
          <option value="Student">Student</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label"><i class="fas fa-calendar"></i> Batch</label>
        <input type="number" class="form-control" id="filterBatch" placeholder="Year">
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button type="button" class="btn btn-custom w-100" onclick="applyFilters()">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </form>
  </div>

  <div id="loading">Loading users...</div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center" id="usersTable">
      <thead>
        <tr>
          <th>#</th>
          <th><i class="fas fa-id-card"></i> Name</th>
          <th><i class="fas fa-envelope"></i> Email</th>
          <th><i class="fas fa-user-tag"></i> Role</th>
          <th><i class="fas fa-calendar"></i> Batch</th>
          <th><i class="fas fa-cogs"></i> Action</th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = "https://1351fwa8h0.execute-api.us-east-1.amazonaws.com/submit";
let allUsers = [];
let currentUsers = [];

// Fetch Users
async function fetchUsers() {
  const loading = document.getElementById("loading");
  loading.style.display = "block";

  try {
    const response = await fetch(API_URL);
    const text = await response.text();
    const data = JSON.parse(text);

    if (!data.data) throw new Error("No 'data' field returned from Lambda");

    allUsers = data.data.map(u => ({
      id: u.id,
      name: u.name || "N/A",
      email: u.email || "N/A",
      batch: u.batch?.toString() || "N/A",
      role: u.role || "N/A"
    }));

    renderTable(allUsers);
  } catch(err) {
    console.error("=== ERROR FETCHING USERS ===", err);
    alert("Failed to fetch users. Check console for details.");
  } finally {
    loading.style.display = "none";
  }
}

// Render Table
function renderTable(users) {
  currentUsers = users;
  const tbody = document.getElementById("usersBody");
  tbody.innerHTML = users.map((user,index)=>`
    <tr>
      <td>${index+1}</td>
      <td>${user.name}</td>
      <td>${user.email}</td>
      <td>${user.role}</td>
      <td>${user.batch}</td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}','${user.role}')">
          <i class="fas fa-trash"></i> Delete
        </button>
      </td>
    </tr>
  `).join('');
}

// Delete User
async function deleteUser(userId, role) {
  if (!confirm("Are you sure you want to delete this user?")) return;

  try {
    const response = await fetch(`${API_URL}?id=${userId}&role=${role}`, {
      method: "DELETE"
    });

    if (!response.ok) throw new Error("Failed to delete user");

    allUsers = allUsers.filter(u => u.id !== userId);
    renderTable(allUsers);

    alert(`User deleted successfully from ${role} table!`);
  } catch (err) {
    console.error("=== ERROR DELETING USER ===", err);
    alert("Failed to delete user. Check console for details.");
  }
}

// Apply Filters
function applyFilters() {
  const name = document.getElementById("filterName").value.toLowerCase();
  const email = document.getElementById("filterEmail").value.toLowerCase();
  const role = document.getElementById("filterRole").value;
  const batch = document.getElementById("filterBatch").value;

  const filtered = allUsers.filter(user => {
    return (!name || user.name.toLowerCase().includes(name)) &&
           (!email || user.email.toLowerCase().includes(email)) &&
           (!role || user.role === role) &&
           (!batch || user.batch === batch);
  });

  renderTable(filtered);
}

// Export CSV
function exportTableToCSV(filename) {
  if (currentUsers.length === 0) {
    alert("No data to export!");
    return;
  }

  const csvRows = [];
  csvRows.push(["SNO","Name","Email","Role","Batch"].join(","));

  currentUsers.forEach((user, index) => {
    csvRows.push([index+1,user.name,user.email,user.role,user.batch].join(","));
  });

  const blob = new Blob([csvRows.join("\n")], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

fetchUsers();
</script>

</body>
</html>
