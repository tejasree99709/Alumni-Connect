<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analytics & Reports | Alumni Connect</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Roboto', sans-serif; background-color: #b1e5f2; margin:0; padding:0; }
.topbar { background-color: #1c2434; color:#fff; padding:15px 30px; display:flex; justify-content:space-between; align-items:center; }
.topbar h1 { font-size:1.5rem; margin:0 auto; }
.content-container { max-width:1100px; margin:40px auto; background:#2f3d5a; padding:30px; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.1); color:#fff; }
.card-box { background:#3e4b6b; border-radius:8px; padding:20px; text-align:center; color:#fff; box-shadow:0 0 10px rgba(0,0,0,0.2); }
.card-box h3 { margin:10px 0 0; font-size:1.8rem; }
.btn-custom { background-color: #b1e5f2; color: #000; border-radius:5px; }
.btn-custom:hover { background-color: #96d3e6; }
</style>
</head>
<body>

<div class="topbar">
  <h1><i class="fas fa-chart-line"></i> Analytics & Reports</h1>
  <a href="Admindashboard.html" class="btn btn-danger"><i class="fas fa-arrow-left"></i> Back</a>
</div>

<div class="content-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fas fa-chart-pie"></i> User Analytics</h3>
    <button class="btn btn-custom" onclick="downloadReport()"><i class="fas fa-download"></i> Download Report</button>
  </div>

  <!-- Summary Cards -->
  <div class="row text-center mb-4">
    <div class="col-md-6 mb-3">
      <div class="card-box">
        <i class="fas fa-user-graduate fa-2x"></i>
        <h5>Total Alumni</h5>
        <h3 id="alumniCount">0</h3>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="card-box">
        <i class="fas fa-user fa-2x"></i>
        <h5>Total Students</h5>
        <h3 id="studentCount">0</h3>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card-box">
        <h5>User Distribution</h5>
        <canvas id="userPieChart"></canvas>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card-box">
        <h5>Registrations Over Time</h5>
        <canvas id="userBarChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://1351fwa8h0.execute-api.us-east-1.amazonaws.com/submit"; // same as view_users
let usersData = []; // store all users

async function fetchAnalytics() {
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error("Failed to fetch data");

    const json = await res.json();
    const users = json.data || [];
    usersData = users; // save globally for CSV download

    const alumni = users.filter(u => u.role === "Alumni");
    const students = users.filter(u => u.role === "Student");

    document.getElementById("alumniCount").innerText = alumni.length;
    document.getElementById("studentCount").innerText = students.length;

    // Pie Chart
    new Chart(document.getElementById('userPieChart'), {
      type: 'pie',
      data: {
        labels: ['Alumni', 'Students'],
        datasets: [{
          data: [alumni.length, students.length],
          backgroundColor: ['#4CAF50', '#2196F3']
        }]
      }
    });

    // Bar Chart (registrations by batch/year)
    const allBatches = [...new Set(users.map(u => u.batch))].sort();
    const registrations = allBatches.map(batch => users.filter(u => u.batch === batch).length);

    new Chart(document.getElementById('userBarChart'), {
      type: 'bar',
      data: {
        labels: allBatches,
        datasets: [{
          label: 'Registrations',
          data: registrations,
          backgroundColor: '#ffc107'
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

  } catch(err) {
    console.error(err);
    alert("Failed to fetch analytics. Check console for details.");
  }
}

// Download CSV Report
function downloadReport() {
  if (!usersData.length) { alert("No data to export!"); return; }

  const csvRows = [];
  csvRows.push(["ID","Name","Email","Role","Batch"].join(","));

  usersData.forEach(u => {
    csvRows.push([u.id||"N/A", u.name, u.email, u.role, u.batch].join(","));
  });

  const blob = new Blob([csvRows.join("\n")], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "analytics_report.csv";
  link.click();
}

// Run analytics on page load
fetchAnalytics();
</script>

</body>
</html>
